<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>OpenJDK的JDK-8254557解决过程 | Guoxiong Li</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="lgx,liguoxiong, lgsbslgx, liguoxiong's Blog">
  
  <meta name="description" content="相关链接 OpenJDK javac compiler 资料 javac邮件列表 关于javac的一个小总结 JDK-8254557 我的Pull Request OpenJDK的测试工具 jtreg  基础知识很多具体的内容都可以在 相关链接 里面找到。这里写一些基本的信息，让没时间深入理解的人也可以大概了解情况。 编译器前端的基本组成javac的作用是把java源程序翻译成中间代码，以编译原理">
<meta name="keywords" content="Java,OpenJDK,Compiler,Javac">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenJDK的JDK-8254557解决过程">
<meta property="og:url" content="http://lgxbslgx.github.io/2020/10/26/OpenJDK-8254557/index.html">
<meta property="og:site_name" content="Guoxiong Li">
<meta property="og:description" content="相关链接 OpenJDK javac compiler 资料 javac邮件列表 关于javac的一个小总结 JDK-8254557 我的Pull Request OpenJDK的测试工具 jtreg  基础知识很多具体的内容都可以在 相关链接 里面找到。这里写一些基本的信息，让没时间深入理解的人也可以大概了解情况。 编译器前端的基本组成javac的作用是把java源程序翻译成中间代码，以编译原理">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2021-07-15T05:10:26.812Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenJDK的JDK-8254557解决过程">
<meta name="twitter:description" content="相关链接 OpenJDK javac compiler 资料 javac邮件列表 关于javac的一个小总结 JDK-8254557 我的Pull Request OpenJDK的测试工具 jtreg  基础知识很多具体的内容都可以在 相关链接 里面找到。这里写一些基本的信息，让没时间深入理解的人也可以大概了解情况。 编译器前端的基本组成javac的作用是把java源程序翻译成中间代码，以编译原理">
  
  
    <link rel="icon" href="/logo.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
  

  
  

</head>
</html>
<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title"></span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a  href="/">
                        <i class="fa fa-home"></i>
                        <span>Home</span>
                    </a>
                    
                    <a  href="/archives">
                        <i class="fa fa-archive"></i>
                        <span>Archives</span>
                    </a>
                    
                    <a  href="/about">
                        <i class="fa fa-user"></i>
                        <span>About</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.jpg" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        Do What U Like
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-OpenJDK-8254557" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="post-title" itemprop="name">
      OpenJDK的JDK-8254557解决过程
    </h1>
    <div class="post-title-bar">
      <ul>
          
        <li>
          <i class="fa fa-calendar"></i>  2020-10-26
        </li>
      </ul>
    </div>
  

          
      </header>
    
      
    <div class="article-entry post-content" itemprop="articleBody">
            
            <h3 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h3><ul>
<li><a href="http://openjdk.java.net/" target="_blank" rel="noopener">OpenJDK</a></li>
<li><a href="http://openjdk.java.net/groups/compiler/" target="_blank" rel="noopener">javac compiler 资料</a></li>
<li><a href="https://mail.openjdk.java.net/mailman/listinfo/compiler-dev" target="_blank" rel="noopener">javac邮件列表</a></li>
<li><a href="https://github.com/lgxbslgx/note/blob/master/openjdk/source_reading_record/javac_source_analysis.md" target="_blank" rel="noopener">关于javac的一个小总结</a></li>
<li><a href="https://bugs.openjdk.java.net/browse/JDK-8254557" target="_blank" rel="noopener">JDK-8254557</a></li>
<li><a href="https://github.com/openjdk/jdk/pull/718" target="_blank" rel="noopener">我的Pull Request</a></li>
<li><a href="http://openjdk.java.net/jtreg/index.html" target="_blank" rel="noopener">OpenJDK的测试工具 jtreg</a></li>
</ul>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>很多具体的内容都可以在 相关链接 里面找到。这里写一些基本的信息，让没时间深入理解的人也可以大概了解情况。</p>
<h4 id="编译器前端的基本组成"><a href="#编译器前端的基本组成" class="headerlink" title="编译器前端的基本组成"></a>编译器前端的基本组成</h4><p>javac的作用是把java源程序翻译成中间代码，以编译原理的角度，就是一个编译器前端。下面简述一个编译器前端的组成。</p>
<ul>
<li>词法分析(lexical analysis, lexer, scanner): 把源程序(一串字符流)进行分词，产生词汇流(token list)。这些词汇也叫token。</li>
<li>语法分析(parser): 读取token流，分析语法是否正确，产生抽象语法树(abstract syntax tree, AST)。</li>
<li>语义分析(semantic analysis): 分析AST的语义是否正确，生成一些分析的结果(可以简单称这些结果为属性attribute)，形成一个新的树(也可以叫AST)。</li>
<li>中间代码生成(code generate): 根据AST树，产生中间代码。</li>
</ul>
<h4 id="javac的基本步骤"><a href="#javac的基本步骤" class="headerlink" title="javac的基本步骤"></a>javac的基本步骤</h4><p>具体语言的编译器前端都有一些特殊的内容，javac的具体步骤如下:</p>
<ul>
<li>1.Parser(使用scanner和tokenizer): 词法分析和语法分析。把scanner和parser两步一起完成，减少一次完整遍历，是编译器的常规操作。</li>
<li>2.Enter: 生成符号，初始化符号表。同时也生成一些类型信息，验证一些注解(使用了Attr)是否正确。</li>
<li>3.Annotation processing: 注解处理。</li>
<li>4.Attr: 分析名称和表达式。</li>
<li>5.Flow: 分析程序流程。</li>
<li>6.Desugar: 简化语法糖。</li>
<li>7.Code generation: 中间代码生成。</li>
</ul>
<p>简单的理解和归纳：上文的第1点就是编译器前端的词法分析和语法分析，上文的2-6就是语义分析，7就是中间代码生成。</p>
<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>详见链接 <a href="https://bugs.openjdk.java.net/browse/JDK-8254557" target="_blank" rel="noopener">JDK-8254557</a> 。下面简单描述一下。有人使用类似下面这段代码的时候，javac编译出错。这个错误不是指javac认为源程序有问题而报错，而是javac本身出现问题，没办法继续运行了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T8254557</span> </span>&#123;</span><br><span class="line">    <span class="comment">// test anonymous class in if statement</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">testIf</span><span class="params">(<span class="keyword">boolean</span> b)</span> </span>&#123;</span><br><span class="line">        test(rs -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (b) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Iterator&lt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(Function function)</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://bugs.openjdk.java.net/browse/JDK-8254557" target="_blank" rel="noopener">JDK-8254557</a> 里面也有一个例子，和我这个类似。上面的例子是我最后提交补丁的时候带的单元测试例子。而报告者也指出如果把<code>new Iterator&lt;&gt;</code>写成<code>new Iterator&lt;T&gt;</code>，就可以编译成功，不会报错。</p>
<h3 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h3><h4 id="寻找原因"><a href="#寻找原因" class="headerlink" title="寻找原因"></a>寻找原因</h4><ul>
<li>从 <a href="https://bugs.openjdk.java.net/browse/JDK-8254557" target="_blank" rel="noopener">JDK-8254557</a> 里的报错信息可以大概知道: javac在判断一个类型是不是另一个类型的子类型时，javac出错了。</li>
<li>我根据错误信息里的调用栈，在代码里打断点一步一步的调试。因为对代码不熟悉，我选择从调用栈第一步<code>jdk.compiler/com.sun.tools.javac.Main.main(Main.java:45)</code>开始。</li>
<li>调试完后，我知道了问题出现的具体场景: 验证注解@Override能否作用在方法(method) <code>public boolean hasNext()</code>上。@Override大家都很常用，作用在子类的重写方法上，很明显例子代码的这种写法是对的。</li>
<li>这个验证流程可以抽象为:<ul>
<li>先获取@Override可以作用的类型，@Override只能作用在方法(method)上。</li>
<li>获取<code>public boolean hasNext()</code>的类型，这是一个方法，理论上类型应该是方法。</li>
<li>然后比较两个类型是否兼容(是否是子类型)，这就和刚刚说的报错信息相对应了。</li>
</ul>
</li>
<li>按照上面的验证流程，为什么会报错呢？原来获取<code>public boolean hasNext()</code>的类型为<code>Unknown</code>，而不是<code>method</code>。这个流程根本不懂得怎么处理一个<code>Unknown</code>类型，只能向上一层抛出错误。</li>
<li>原因总结: javac前面的步骤把本应该是<code>method</code>类型的信息解析成了一个<code>Unknown</code>类型，使得验证注解@Override的可作用类型时出错。</li>
</ul>
<h4 id="尝试解决"><a href="#尝试解决" class="headerlink" title="尝试解决"></a>尝试解决</h4><ul>
<li>思路: 既然这次验证不懂得怎么处理<code>Unknown</code>类型，那我在遇到<code>Unknown</code>类型的时候，先调用适当的方法重新分析类型，再进行验证。</li>
<li>我发现错误信息的调用栈上有一个方法<code>Annotation.attributeAnnotationValues</code>，它在验证之前先判断类型是否为空，为空的话，就分析其类型。代码如下:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> List&lt;Pair&lt;MethodSymbol, Attribute&gt;&gt; attributeAnnotationValues(JCAnnotation a,</span><br><span class="line">        Type expected, Env&lt;AttrContext&gt; env)</span><br><span class="line">&#123;</span><br><span class="line">	Type at = (a.annotationType.type != <span class="keyword">null</span> ?</span><br><span class="line">            a.annotationType.type : attr.attribType(a.annotationType, env));</span><br><span class="line">	a.type = chk.checkType(a.annotationType.pos(), at, expected);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 省略下面的代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>那能不能再判断一下类型是否为<code>Unknown</code>，是<code>Unknown</code>的话，就分析其类型呢？我基于这个想法，把代码修改如下。这是现在总结的时候临时写的，当时具体的代码已经没有了。使用这段代码可能报错。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Type at = ((a.annotationType.type != <span class="keyword">null</span> &amp;&amp; a.annotationType.type != UnknownType) ?</span><br><span class="line">           a.annotationType.type : attr.attribType(a.annotationType, env)); <span class="comment">// 加了对`Unknown`类型的判断</span></span><br><span class="line">a.type = chk.checkType(a.annotationType.pos(), at, expected); <span class="comment">// 这句没变</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我写了一个单元测试，测试我的解决方案是否正确。单元测试代码 类似 问题描述那节的例子代码和这个 <a href="https://bugs.openjdk.java.net/browse/JDK-8254557" target="_blank" rel="noopener">bug JDK-8254557</a> 里的代码。<ul>
<li>OpenJDK的单元测试使用了一个叫<a href="http://openjdk.java.net/jtreg/index.html" target="_blank" rel="noopener">jtreg</a>的内部工具，因为OpenJDK开始开发的时候，junit这些单元测试框架还没出现，OpenJDK内部只能自己写一个单元测试工具。jtreg的详细内容读者可以自己看上面的链接，而我最终补丁里的单元测试内容可以看<a href="https://github.com/openjdk/jdk/pull/718" target="_blank" rel="noopener">我的PR</a>。</li>
</ul>
</li>
<li>结果是单元测试没通过，我的解决方案中，返回的变量<code>at</code>依然是<code>Unknown</code>。</li>
<li>总结: 这个解决方案不管<code>Unknown</code>类型是怎么得来的，只对<code>Unknown</code>类型的内容再重新分析类型，最终还是没有解决问题。</li>
</ul>
<h4 id="寻找根本原因"><a href="#寻找根本原因" class="headerlink" title="寻找根本原因"></a>寻找根本原因</h4><ul>
<li>思路: 找到最开始分析出<code>Unknown</code>类型的地方，那里的代码极有可能出错了。 这个bug出现的地方属于上面javac基本步骤里的Attr，那分析出<code>Unknown</code>类型的代码应该在前面的Parser和Enter阶段。</li>
<li>我继续调试代码，主要是Parse和Enter阶段的代码，也有Attr阶段的代码。(我发现Enter的有些过程用到了Attr的一些方法，Attr也会使用Enter做一些操作，这个和我之前理解的严格分阶段有些不同，文档也没有强调说明，这种坑只能自己踩了)</li>
<li>最终发现问题所在:<ul>
<li>首先，Attr会递归分析所有名称和表达式的类型。但是当分析匿名内部类的时候，有一种情况，Attr会跳过匿名内部类，在分析完所有地方之后，再回来分析刚刚忽略的匿名内部类。这种情况极其特殊，很难出现，具体判断代码为: <code>if (isDiamond &amp;&amp; ((tree.constructorType != null &amp;&amp; inferenceContext.free(tree.constructorType)) || (tree.clazz.type != null &amp;&amp; inferenceContext.free(tree.clazz.type))))</code>。isDiamond表示是否为棱型泛型，也就是<code>&lt;&gt;</code>，注意尖括号里面什么都没有。看到这个是不是觉得有点熟悉，前面问题描述里面提到把<code>&lt;&gt;</code>改成<code>&lt;T&gt;</code>就没有bug了。 这种情况还要求默认构造函数需要含有泛型，或者匿名类类型含有泛型。换句话说，就是你写代码的时候匿名类上写的是<code>&lt;&gt;</code>，而javac分析之后，把你的类型或者构造函数类型变成了<code>&lt;T&gt;</code>。这种条件极其苛刻，以至于你把问题描述例子代码里的 方法test()、lambda表达式、if语句、使用&lt;&gt;匿名类 的其中一层去掉，都无法重现问题。</li>
<li>另一方面，Attr会在分析完 lambda表达式、if语句、while语句、do while语句、for语句 之后，调用一个preFlow方法，preFlow把这些语句里面 未分析出类型的所有内容，都置成了<code>Unknown</code>类型。这样做是合理的，因为分析完一棵子树之后，没分析出一些内容的类型，说明这些内容可能出现了语义错误。为了避免以后的处理出现空指针，只能把这些类型置为<code>Unknown</code>。</li>
<li>刚刚说的两个方面都是合理的。因为<code>&lt;&gt;</code>匿名类可能需要其他地方的信息才能推导出具体的泛型信息，所以要推迟分析; 而类型为空，会让之后的flow阶段报空指针错误，所以要置为<code>Unknown</code>类型。但是这两种情况一结合，就出现bug了。在 lambda表达式、if语句、while语句、do while语句、for语句 里面的 满足第一种情况的<code>&lt;&gt;</code>匿名类，会被preFlow把匿名类里面所有内容的类型置为<code>Unknown</code>。从而导致了后来Attr使用类型时，遇到<code>Unknown</code>报错。</li>
<li>分析到这里，我们大概知道解决方案：修改preFlow方法，让它不修改刚刚跳过的&lt;&gt;匿名类内容的类型(即不把刚刚跳过的内容置为<code>Unknown</code>，让它为空)。</li>
</ul>
</li>
<li>在看preFlow方法的时候，根据一些注释内容，我发现一些额外信息:<ul>
<li>之前有一个类似的bug <a href="https://bugs.openjdk.java.net/browse/JDK-8203277" target="_blank" rel="noopener">JDK-8203277</a>。对应的解决方法在 <a href="http://hg.openjdk.java.net/jdk/jdk/rev/605878cd4009" target="_blank" rel="noopener">这里</a>。它解决了lambda表达式里面使用preFlow出现的问题。</li>
<li>而 <a href="https://bugs.openjdk.java.net/browse/JDK-8231826" target="_blank" rel="noopener">JDK-8231826</a> 解决过程中，提交了一些 <a href="https://hg.openjdk.java.net/jdk/jdk/rev/7799a51dbe30" target="_blank" rel="noopener">代码</a>。这些代码在 Attr分析 if语句、while语句、do while语句、for语句 的时候使用preFlow, 导致了现在这个问题 <a href="https://bugs.openjdk.java.net/browse/JDK-8254557" target="_blank" rel="noopener">JDK-8254557</a>。这可以说是bug <a href="https://bugs.openjdk.java.net/browse/JDK-8203277" target="_blank" rel="noopener">JDK-8203277</a> 的回退(regression)。</li>
</ul>
</li>
<li>总结: preFlow导致了不必要的<code>Unknown</code>类型产生，有些需要使用类型的程序无法理解和解析<code>Unknown</code>，从而抛出错误。</li>
</ul>
<h4 id="最终解决方案"><a href="#最终解决方案" class="headerlink" title="最终解决方案"></a>最终解决方案</h4><ul>
<li><a href="https://bugs.openjdk.java.net/browse/JDK-8203277" target="_blank" rel="noopener">JDK-8203277</a> 的 <a href="http://hg.openjdk.java.net/jdk/jdk/rev/605878cd4009" target="_blank" rel="noopener">解决方案</a> 重写了<code>PostAttrAnalyzer</code>的<code>visitClassDef</code>和<code>visitLamda</code>方法，如下所示。可以看到<code>visitClassDef</code>和<code>visitLamda</code>方法里面没有内容，表示所有匿名类和lambda表达式preFlow都不检查(即对里面真正错误的内容都没管，没设置为<code>Unknown</code>)。这其实不是最优的方案。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preFlow</span><span class="params">(JCLambda tree)</span> </span>&#123;</span><br><span class="line">    attrRecover.doRecovery();</span><br><span class="line">    <span class="keyword">new</span> PostAttrAnalyzer() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(JCTree tree)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (tree == <span class="keyword">null</span> ||</span><br><span class="line">                    (tree.type != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    tree.type == Type.stuckType)) &#123;</span><br><span class="line">                <span class="comment">//don't touch stuck expressions!</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.scan(tree);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitClassDef</span><span class="params">(JCClassDecl that)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// or class declaration trees!</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitLambda</span><span class="params">(JCLambda that)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// or lambda expressions!</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.scan(tree.body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>我的解决方案在它基础上改善了一些内容。我在<code>visitClassDef</code>和<code>visitLamda</code>方法里面做了条件判断，让preFlow不检查这种没解析过的匿名类和lambda表达式。而对于已经解析过的匿名类和lambda表达式，preFlow一样检查和设置<code>Unknown</code>类型。代码如下所示：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preFlow</span><span class="params">(JCTree tree)</span> </span>&#123;</span><br><span class="line">    attrRecover.doRecovery();</span><br><span class="line">    <span class="keyword">new</span> PostAttrAnalyzer() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scan</span><span class="params">(JCTree tree)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (tree == <span class="keyword">null</span> ||</span><br><span class="line">                    (tree.type != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    tree.type == Type.stuckType)) &#123;</span><br><span class="line">                <span class="comment">//don't touch stuck expressions!</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.scan(tree);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitClassDef</span><span class="params">(JCClassDecl that)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (that.sym != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Method preFlow shouldn't visit class definitions</span></span><br><span class="line">                <span class="comment">// that have not been entered and attributed.</span></span><br><span class="line">                <span class="comment">// See JDK-8254557 and JDK-8203277 for more details.</span></span><br><span class="line">                <span class="keyword">super</span>.visitClassDef(that);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitLambda</span><span class="params">(JCLambda that)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (that.type != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Method preFlow shouldn't visit lambda expressions</span></span><br><span class="line">                <span class="comment">// that have not been entered and attributed.</span></span><br><span class="line">                <span class="comment">// See JDK-8254557 and JDK-8203277 for more details.</span></span><br><span class="line">                <span class="keyword">super</span>.visitLambda(that);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.scan(tree);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://bugs.openjdk.java.net/browse/JDK-8254557" target="_blank" rel="noopener">JDK-8254557</a> 描述里面只有 if语句 对应的测试案例。我在阅读源码时候，知道 while语句、do while语句、for语句也有对应的问题。所以我加上了对应的测试案例，完善了我之前写的单元测试。 <a href="https://github.com/openjdk/jdk/pull/718/files" target="_blank" rel="noopener">具体代码</a></li>
</ul>
<h4 id="提交补丁以及社区交流"><a href="#提交补丁以及社区交流" class="headerlink" title="提交补丁以及社区交流"></a>提交补丁以及社区交流</h4><ul>
<li>OpenJDK从JDK16开始从Mercurial迁移到Git，并且使用Github的Pull Request进行代码review。详情请见: <a href="http://openjdk.java.net/projects/jdk/16/" target="_blank" rel="noopener">JDK 16</a>, <a href="https://openjdk.java.net/jeps/357" target="_blank" rel="noopener">JEP 357: Migrate from Mercurial to Git</a> 和 <a href="https://openjdk.java.net/jeps/369" target="_blank" rel="noopener">JEP 369: Migrate to GitHub</a></li>
<li>和常规的Github Pull Request操作一样。新建分支JDK-8254557，提交对应的代码，push到自己的 <a href="https://github.com/openjdk/jdk" target="_blank" rel="noopener">Github仓库</a>, 然后提 <a href="https://github.com/openjdk/jdk/pull/718" target="_blank" rel="noopener">Pull Request</a>.</li>
<li>如果没有签OCA的话，需要签OCA，我已经签过了。签OCA的流程如下: 下载 <a href="https://www.oracle.com/technetwork/oca-405177.pdf" target="_blank" rel="noopener">OCA</a>，写相关信息并签名，拍一个照片发给邮箱<a href="mailto:oracle-ca_us@oracle.com" target="_blank" rel="noopener">oracle-ca_us@oracle.com</a>，Oracle审核完之后，就会回复你。更多详情如下:  <a href="https://www.oracle.com/technical-resources/oracle-contributor-agreement.html" target="_blank" rel="noopener">OCA</a> <a href="https://openjdk.java.net/bylaws#contributor" target="_blank" rel="noopener">contributor</a></li>
<li>签完OCA后，第一次在Github贡献代码，需要在PR的评论里面写<code>/signed</code>，表示你已经签过OCA，然后Oracle的人就会发邮件问你这个Github帐号是不是你的。回复邮件确定就可以了。可以看 <a href="https://github.com/openjdk/jdk/pull/622" target="_blank" rel="noopener">这里</a> 了解具体操作。</li>
<li>之后就会有人来review你的代码，代码需要1到多个人review，具体人数 根据代码修改的内容来定，如果是虚拟机的代码就需要至少2个人review。</li>
<li>review完成后，需要在评论里面写<code>/integrate</code>进行集成，如果你的帐号有commit权限(OpenJDK的Committer以上才有)，代码就会自动被合成。如果没有，就会有一个Committer以上的人在评论里写<code>/sponsor</code>，以他的帐号提交你的代码(这个patch的贡献者还是你)。一般review你代码的人，会顺便sponsor的，如果隔几天没人sponsor，你可以在评论里面问一下。</li>
<li>遇到问题可以多看一下别人的PR，和根据机器人指示看对应的文档。</li>
</ul>
<h3 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h3><ul>
<li>注意: <a href="https://bugs.openjdk.java.net/browse/JDK-8203277" target="_blank" rel="noopener">JDK-8203277</a> 是一个影响OpenJDK9、10、11的bug，在当时的开发主线(main line, 也就是当前正在开发的最新版本)JDK12得到了解决。2018年9月OpenJDK11发布，这个问题在2018年11月解决，刚好错过了。我现在使用OpenJDK11的最新代码测试，bug还存在。不知道什么原因，这个补丁没有backport(向后移植)到之前的版本。<br>而我解决的 <a href="https://bugs.openjdk.java.net/browse/JDK-8254557" target="_blank" rel="noopener">JDK-8254557</a> 则是在OpenJDK11、14、15、16(9和10已经不再维护，14也将不再维护)都出现的问题，然而我的补丁也只是提交到开发主线(当前的开发主线OpenJDK16)，也就是说JDK11、14、15还是没有解决这个问题的。</li>
<li>友情提示: 公司技术选型，一定要选8和11这种长期支持的版本，而且要及时更新！要不然掉坑里都不知道。</li>
<li>如果大家对OpenJDK感兴趣，欢迎发邮件和我交流。</li>
</ul>

            <div class="post-copyright">

</div>

    </div>
      
        
            
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;">Reward</a>
</div>

<div id="reward" class="post-modal reward-lay">
    <a class="close" href="javascript:;" id="reward-close">×</a>
    <span class="reward-title">
        <i class="icon icon-quote-left"></i>
        Reward
        <i class="icon icon-quote-right"></i>
    </span>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/images/wechat_pay.jpg" alt="打赏二维码">
        </div>
        <div class="reward-select">
            
            <label class="reward-select-item checked" data-id="wechat" data-wechat="/images/wechat_pay.jpg">
                <img class="reward-select-item-wechat" src="/images/wechat.png" alt="WeChat">
            </label>
            
            
            <label class="reward-select-item" data-id="alipay" data-alipay="/images/alipay.jpg">
                <img class="reward-select-item-alipay" src="/images/alipay.png" alt="Alipay">
            </label>
            
        </div>
    </div>
</div>


        
    <footer class="article-footer">
        
        
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://lgxbslgx.github.io/2020/10/26/OpenJDK-8254557/&title=《OpenJDK的JDK-8254557解决过程》 — Guoxiong Li&pic=http://lgxbslgx.github.ioimages/logo.jpg" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://lgxbslgx.github.io/2020/10/26/OpenJDK-8254557/&title=《OpenJDK的JDK-8254557解决过程》 — Guoxiong Li&source=Guoxiong Li" data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://lgxbslgx.github.io/2020/10/26/OpenJDK-8254557/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《OpenJDK的JDK-8254557解决过程》 — Guoxiong Li&url=http://lgxbslgx.github.io/2020/10/26/OpenJDK-8254557/&via=http://lgxbslgx.github.io" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://lgxbslgx.github.io/2020/10/26/OpenJDK-8254557/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://lgxbslgx.github.io/2020/10/26/OpenJDK-8254557/" alt="微信分享二维码">
</div>

<div class="mask"></div>

        
        <ul class="article-footer-menu">
            
            
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/tags/Java/" class="color5">Java</a>
      
    <a href="/tags/OpenJDK/" class="color3">OpenJDK</a>
      
    <a href="/tags/Compiler/" class="color4">Compiler</a>
      
    <a href="/tags/Javac/" class="color1">Javac</a>
      
  </li>

        </ul>
        
    </footer>
  </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#相关链接"><span class="post-toc-text">相关链接</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#基础知识"><span class="post-toc-text">基础知识</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#编译器前端的基本组成"><span class="post-toc-text">编译器前端的基本组成</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#javac的基本步骤"><span class="post-toc-text">javac的基本步骤</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#问题描述"><span class="post-toc-text">问题描述</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#解决过程"><span class="post-toc-text">解决过程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#寻找原因"><span class="post-toc-text">寻找原因</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#尝试解决"><span class="post-toc-text">尝试解决</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#寻找根本原因"><span class="post-toc-text">寻找根本原因</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#最终解决方案"><span class="post-toc-text">最终解决方案</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#提交补丁以及社区交流"><span class="post-toc-text">提交补丁以及社区交流</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#题外话"><span class="post-toc-text">题外话</span></a></li></ol>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/2020/11/20/OpenJDK-Contribution-Summary/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          OpenJDK Main-line Contribution Summary
        
      </span>
    </a>
  
  
    <a href="/2019/05/14/Commit-the-code-to-spring-framework-for-the-first-time/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">spring-framework的issue-22675解决过程</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>



    
</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      

      <p>
        Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
      &copy; 2022 Guoxiong Li<br>
      </p>
    </div>
  </div>
</footer>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "http://lgxbslgx.github.io",
      animate: false,
      isHome: false,
      share: true,
      reward: 1
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/Compiler/" style="font-size: 13.33px;">Compiler</a> <a href="/tags/JVM/" style="font-size: 13.33px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Javac/" style="font-size: 16.67px;">Javac</a> <a href="/tags/OpenJDK/" style="font-size: 20px;">OpenJDK</a> <a href="/tags/hotspot/" style="font-size: 13.33px;">hotspot</a> <a href="/tags/spring-framework/" style="font-size: 10px;">spring-framework</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a  href="/">
                    <i class="fa fa-home"></i><span>Home</span>
                </a>
            </li>
            
            <li>
                <a  href="/archives">
                    <i class="fa fa-archive"></i><span>Archives</span>
                </a>
            </li>
            
            <li>
                <a  href="/about">
                    <i class="fa fa-user"></i><span>About</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/Compiler/" style="font-size: 13.33px;">Compiler</a> <a href="/tags/JVM/" style="font-size: 13.33px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Javac/" style="font-size: 16.67px;">Javac</a> <a href="/tags/OpenJDK/" style="font-size: 20px;">OpenJDK</a> <a href="/tags/hotspot/" style="font-size: 13.33px;">hotspot</a> <a href="/tags/spring-framework/" style="font-size: 10px;">spring-framework</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>









  <script src="/js/pop-img.js"></script>
  <script>
     $(".article-entry p img").popImg();
  </script>

  </div>
</body>
</html>